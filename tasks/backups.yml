---

- name: Ensure that restic backup config(s) are in place.
  template:
    dest: "{{ backupninja_config_dir }}/{{ item.key }}.restic"
    src: '../files/example.restic.j2'
    force: yes
    owner: 'root'
    group: 'root'
    mode: '0600'
  vars:
    repo: "{{ item.value.repo | default(restic_default_repo) }}"
    password: "{{ item.value.password }}"
    aws_key: "{{ item.value.aws_key | default(omit) }}"
    aws_secret: "{{ item.value.aws_secret |default(omit) }}"
    backup: "{{ item.value.backup }}"
    retention: "{{ item.value.retention }}"
    check: "{{ item.value.check }}"
    includes: "{{ item.value.includes }}"
    excludes: "{{ item.value.excludes }}"
    snapshot_tags: "{{ item.value.tags }}"
    keep:
      last: "{{ item.value.keep.last }}"
      hourly: "{{ item.value.keep.hourly }}"
      daily: "{{ item.value.keep.daily }}"
      weekly: "{{ item.value.keep.weekly }}"
      monthly: "{{ item.value.keep.monthly }}"
      yearly: "{{ item.value.keep.yearly }}"
      tags: "{{ item.value.keep.tags }}"
  with_dict: "{{ backup_configs }}"
  when: item.value.type | default('restic') == 'restic'

- name: Ensure that mysql backup config(s) are in place.
  template:
    dest: "{{ backupninja_config_dir }}/{{ item.key }}.restic"
    src: 'files/example.mysql.j2'
    force: yes
    owner: 'root'
    group: 'root'
    mode: '0600'
  vars:
    backupninja_mysql_databases: "{{ item.value.databases | default(backupninja_mysql_databases) }}"
    backupninja_mysql_backup_dir: "{{ item.value.backup_dir | default(backupninja_mysql_backup_dir) }}"
  with_dict: "{{ backup_configs }}"
  when: item.value.type | default('restic') == 'mysql'
