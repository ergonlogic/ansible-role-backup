---

- name: Ensure that restic backup config(s) are in place.
  template:
    dest: "{{ backupninja_config_dir }}/{{ item.key }}.restic"
    src: '../files/example.restic.j2'
    force: yes
    owner: 'root'
    group: 'root'
    mode: '0600'
  vars:
    repo: "{{ item.value.repo | default(restic_default_repo) }}"
    password: "{{ item.value.password }}"
    aws_key: "{{ item.value.aws_key | default(omit) }}"
    aws_secret: "{{ item.value.aws_secret | default(omit) }}"
    backup: "{{ item.value.backup | default(omit) }}"
    retention: "{{ item.value.retention | default(omit) }}"
    check: "{{ item.value.check | default(omit) }}"
    includes: "{{ item.value.includes | default(omit) }}"
    excludes: "{{ item.value.excludes | default(omit) }}"
    snapshot_tags: "{{ item.value.tags | default(omit) }}"
    keep:
      last: "{{ item.value.keep.last | default(omit) }}"
      hourly: "{{ item.value.keep.hourly | default(omit) }}"
      daily: "{{ item.value.keep.daily | default(omit) }}"
      weekly: "{{ item.value.keep.weekly | default(omit) }}"
      monthly: "{{ item.value.keep.monthly | default(omit) }}"
      yearly: "{{ item.value.keep.yearly | default(omit) }}"
      tags: "{{ item.value.keep.tags | default(omit) }}"
  with_dict: "{{ backup_configs }}"
  when: item.value.type | default('restic') == 'restic'

- name: Ensure that mysql backup config(s) are in place.
  template:
    dest: "{{ backupninja_config_dir }}/{{ item.key }}.restic"
    src: 'files/example.mysql.j2'
    force: yes
    owner: 'root'
    group: 'root'
    mode: '0600'
  vars:
    backupninja_mysql_databases: "{{ item.value.databases | default(backupninja_mysql_databases) }}"
    backupninja_mysql_backup_dir: "{{ item.value.backup_dir | default(backupninja_mysql_backup_dir) }}"
  with_dict: "{{ backup_configs }}"
  when: item.value.type | default('restic') == 'mysql'
